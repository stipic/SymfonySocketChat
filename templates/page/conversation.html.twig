{% extends 'base.html.twig' %}

{% block stylesheets %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/file-uploader/3.7.0/fineuploader.min.css" rel="stylesheet">
    {{ encore_entry_link_tags('conversation') }}
{% endblock %}

{% block body %}
    
    <div><a href="/">Back to conversations</a></div>
    <ul id="chat-list">
        {% for message in messages %}

            <li>{{ message.getCreatedBy().getDisplayName() == app.user.displayName ? 'me' : message.getCreatedBy().getDisplayName() }}: {{ message.content | raw }}</li>
        
        {% endfor %}
    </ul>

    <div id="writing"></div>

    <div>
        <textarea id="form-message" placeholder="Your public message here"></textarea>
        <input type="button" id="form-submit" value="Send message"/>

    </div>

    <div id="fine-uploader"></div>
</form>


    <div>Users in conversation:</div>
    <ul>
        {% for user in conversation.getUsers() %}
            <li>{{ user.username }}</li>
        {% endfor %}
    </ul>

    <div>
    {% for conversation in conversations %}

        {% set userUuid = '' %}
        {% if conversation.isChannel == false %}

            {% set channelName = conversation.conversationNameForOwner %}
            {% if conversation.createdBy != app.user %}
                {% set channelName = conversation.conversationNameForGuest %}
            {% endif %}

            {% for userInsideThisConversation in conversation.users.getValues() %}
                {% if userInsideThisConversation != app.user %}
                    {% set userUuid = '<span data-usid=' ~ userInsideThisConversation.id ~ '>[offline]</span>' %}
                {% endif %}
            {% endfor %}
            

        {% else %}

            {% set channelName = conversation.channelName %}

        {% endif %}


        <li>{{ userUuid | raw }}<a href="/conversation/{{ conversation.id }}">{{ channelName }}</a>
    
    {% endfor %}
    </div>


{% endblock %}

{% block javascripts %}
    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/file-uploader/3.7.0/fineuploader.min.js"></script>
    <script type="text/javascript">
        var uploader = new qq.FineUploader({
            element: document.getElementById('fine-uploader'),
            request: {
                endpoint: "{{ oneup_uploader_endpoint('gallery') }}",
                params: {
                    conversationId: {{ conversation.id }}
                }
            }
        });
    </script>
    
    <script type="text/javascript">
        var clientInformation = {
            payloadType: 'text',
            username: '{{ app.user.username }}',
            wsConversationRoute: 'conversation/{{ conversation.id }}',
            conversationId: {{ conversation.id }},
            displayName: '{{ app.user.displayName }}'
        };
    </script>
    <script type="text/javascript" src="{{ asset('bundles/goswebsocket/js/vendor/autobahn.min.js') }}"></script>
    <script type="text/javascript" src="{{ asset('bundles/goswebsocket/js/gos_web_socket_client.js') }}"></script>
    {{ encore_entry_script_tags('conversation') }}
{% endblock %}